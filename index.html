<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Korzinka • TMS • Реестр отгрузок</title>
<meta name="description" content="Korzinka TMS: прототип реестра отгрузок и доставок (редактируемая таблица из Excel)."/>
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config={theme:{extend:{colors:{brand:{primary:'#C8102E',accent:'#FF3B30',soft:'#FFF5F5',ink:'#1F2937'}},boxShadow:{smooth:'0 6px 18px rgba(0,0,0,.08)'}}}};
</script>
<style>
.brand-gradient{background:linear-gradient(90deg,#C8102E 0%,#FF3B30 100%)}
.sticky-th th{position:sticky;top:0;background:#f8fafc;z-index:2}
.sticky-left{position:sticky;left:0;background:#fff;z-index:3}
.cell{min-width:160px}
</style>
</head>
<body class="bg-brand-soft text-brand-ink">
<div id="root"></div>

<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="text/babel" data-presets="env,react">
const {useState,useEffect,useMemo} = React;

async function load(url){ const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error(url); return r.json(); }

function Cell({col,value,onChange}){
 const v=value??'';
 if(col.type==='select') return (
  <select className="border border-slate-200 rounded-lg px-2 py-1 cell bg-white" value={v} onChange={e=>onChange(e.target.value)}>
   <option value="">—</option>
   {(col.options||[]).map(o=><option key={o} value={o}>{o}</option>)}
  </select>
 );
 if(col.type==='date') return <input type="date" className="border border-slate-200 rounded-lg px-2 py-1 cell" value={v} onChange={e=>onChange(e.target.value)}/>;
 if(col.type==='time') return <input type="time" className="border border-slate-200 rounded-lg px-2 py-1 cell" value={v} onChange={e=>onChange(e.target.value)}/>;
 if(col.type==='number') return <input type="number" className="border border-slate-200 rounded-lg px-2 py-1 cell" value={v} onChange={e=>onChange(e.target.value)}/>;
 return <input className="border border-slate-200 rounded-lg px-2 py-1 cell" value={v} onChange={e=>onChange(e.target.value)}/>;
}

function App(){
 const [schema,setSchema]=useState(null);
 const [rows,setRows]=useState([]);
 const [q,setQ]=useState('');

 useEffect(()=>{ (async()=>{
  const s=await load('./schema.json');
  const d=await load('./data.json');
  setSchema(s);
  setRows(d.map((r,i)=>({_id:i+1,...r})));
 })().catch(err=>{console.error(err); alert('Не удалось загрузить schema.json/data.json');}); },[]);

 const filtered=useMemo(()=>{
  if(!schema) return [];
  if(!q.trim()) return rows;
  const qq=q.toLowerCase();
  const keys=schema.slice(0,12).map(c=>c.key);
  return rows.filter(r=>keys.some(k=>String(r[k]??'').toLowerCase().includes(qq)));
 },[schema,rows,q]);

 if(!schema) return <div className="min-h-screen flex items-center justify-center text-slate-600">Загрузка…</div>;

 return (
 <div>
  <header className="brand-gradient text-white">
   <div className="max-w-7xl mx-auto px-4 py-5 flex items-center justify-between gap-4">
    <div>
     <div className="text-xl font-semibold">Korzinka • TMS</div>
     <div className="opacity-90">Реестр отгрузок / доставок</div>
    </div>
    <div className="text-xs px-3 py-1 rounded-full bg-white/15 border border-white/25">Build: v3 2026-01-13 09:39</div>
   </div>
  </header>

  <main className="max-w-[1500px] mx-auto px-4 py-6 space-y-3">
   <div className="bg-white rounded-2xl shadow-smooth border border-slate-200 p-4 flex flex-wrap items-end justify-between gap-3">
    <div>
     <div className="font-semibold">Поиск</div>
     <div className="text-sm text-slate-500">Ищет по первым колонкам (для скорости).</div>
    </div>
    <input className="h-10 w-full md:w-[420px] rounded-lg border border-slate-200 px-3" value={q} onChange={e=>setQ(e.target.value)} placeholder="например: госномер, статус, номер документа…"/>
    <div className="text-sm text-slate-500">Показано: <span className="font-semibold text-slate-800">{filtered.length}</span></div>
   </div>

   <div className="bg-white rounded-2xl shadow-smooth border border-slate-200 overflow-auto max-h-[75vh]">
    <table className="text-sm">
     <thead className="sticky-th border-b text-left text-slate-600">
      <tr>
       <th className="px-3 py-2 sticky-left">#</th>
       {schema.map(c=><th key={c.key} title={c.key} className="px-3 py-2 whitespace-normal min-w-[180px] max-w-[280px]">{c.label || c.key}</th>)}
      </tr>
     </thead>
     <tbody>
      {filtered.map(r=>(
       <tr key={r._id} className="border-b hover:bg-slate-50">
        <td className="px-3 py-2 sticky-left font-medium">Row {r._id}</td>
        {schema.map(c=>(
         <td key={c.key} className="px-3 py-2">
          <Cell col={c} value={r[c.key]} onChange={v=>setRows(prev=>prev.map(x=>x._id===r._id?{...x,[c.key]:v}:x))}/>
         </td>
        ))}
       </tr>
      ))}
     </tbody>
    </table>
   </div>
  </main>
 </div>
 );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
